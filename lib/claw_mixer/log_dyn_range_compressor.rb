module ClawMixer
  class LogDynRangeCompressor
    def compress(value, channels_count)
      distance = value.abs

      if distance < threshold
        value
      else
        (value / distance) * (
          # Start 0 at threshold
          threshold +
          (
            (1 - threshold) *
            (
              Math.log2(
                1 + knee * (
                  # Normalize input depending on channels number
                  (distance - threshold) / (channels_count - threshold)
                )
              ) /
              Math.log2(1 + knee)
            )
          )
        )
      end
    end

    def knee
      KNEES[threshold]
    end

    def threshold
      @threshold ||= 0.6
    end

    def threshold=(value)
      if value >= 1 || value < 0
        raise ArgumentError.new("Threshold should be between 0.00 and 0.99")
      end

      @threshold = value.round(2)
    end
  end

  KNEES = {
    0.00 => 2.51,
    0.01 => 2.54,
    0.02 => 2.57,
    0.03 => 2.60,
    0.04 => 2.63,
    0.05 => 2.67,
    0.06 => 2.70,
    0.07 => 2.73,
    0.08 => 2.77,
    0.09 => 2.80,
    0.10 => 2.84,
    0.11 => 2.88,
    0.12 => 2.92,
    0.13 => 2.96,
    0.14 => 3.00,
    0.15 => 3.04,
    0.16 => 3.08,
    0.17 => 3.12,
    0.18 => 3.17,
    0.19 => 3.21,
    0.20 => 3.26,
    0.21 => 3.31,
    0.22 => 3.36,
    0.23 => 3.41,
    0.24 => 3.47,
    0.25 => 3.52,
    0.26 => 3.58,
    0.27 => 3.63,
    0.28 => 3.69,
    0.29 => 3.76,
    0.30 => 3.82,
    0.31 => 3.88,
    0.32 => 3.95,
    0.33 => 4.02,
    0.34 => 4.10,
    0.35 => 4.17,
    0.36 => 4.25,
    0.37 => 4.33,
    0.38 => 4.41,
    0.39 => 4.50,
    0.40 => 4.59,
    0.41 => 4.68,
    0.42 => 4.78,
    0.43 => 4.88,
    0.44 => 4.98,
    0.45 => 5.09,
    0.46 => 5.21,
    0.47 => 5.32,
    0.48 => 5.45,
    0.49 => 5.58,
    0.50 => 5.71,
    0.51 => 5.85,
    0.52 => 6.00,
    0.53 => 6.15,
    0.54 => 6.32,
    0.55 => 6.49,
    0.56 => 6.67,
    0.57 => 6.85,
    0.58 => 7.05,
    0.59 => 7.26,
    0.60 => 7.48,
    0.61 => 7.72,
    0.62 => 7.97,
    0.63 => 8.23,
    0.64 => 8.51,
    0.65 => 8.81,
    0.66 => 9.12,
    0.67 => 9.46,
    0.68 => 9.83,
    0.69 => 10.21,
    0.70 => 10.63,
    0.71 => 11.08,
    0.72 => 11.57,
    0.73 => 12.10,
    0.74 => 12.68,
    0.75 => 13.30,
    0.76 => 13.99,
    0.77 => 14.74,
    0.78 => 15.57,
    0.79 => 16.49,
    0.80 => 17.51,
    0.81 => 18.65,
    0.82 => 19.94,
    0.83 => 21.40,
    0.84 => 23.06,
    0.85 => 24.97,
    0.86 => 27.19,
    0.87 => 29.79,
    0.88 => 32.88,
    0.89 => 36.60,
    0.90 => 41.15,
    0.91 => 46.85,
    0.92 => 54.13,
    0.93 => 63.75,
    0.94 => 76.96,
    0.95 => 96.09,
    0.96 => 125.94,
    0.97 => 178.12,
    0.98 => 289.20,
    0.99 => 655.12
  }
end